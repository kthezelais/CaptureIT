<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaptureIT : Connexion</title>
</head>

<body>
    <script>
        if (localStorage.getItem('connected') !== null && localStorage.getItem('connected') != false) {
            document.location.href = "index-tmp.html";
        }
    </script>

    <section>

        <article>

            <form id="form-login" action="" method="post">

                <input type="text" name="login" id="login" placeholder="Pseudo" required><br>

                <input type="password" name="password" id="password" placeholder="Mot de passe" required><br>

                <input type="url" name="server" id="server" placeholder="Adresse de votre serveur" required><br>

                <input type="submit" value="Connexion"><br>

            </form>

        </article>

        <article>
            <p id="result"></p>
        </article>

    </section>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
        $("#form-login").on('submit', function(event) {
            var msg = "";
            var login = $('#login').val();
            var password = $('#password').val();
            var url = $('#server').val() + "/CaptureIT/backend/login.php";
            var backend = $('#server').val() + "/CaptureIT/backend/";

            auth = btoa(login + ':' + password);

            event.preventDefault();

            var data = '{' +
                '"content" : "' + auth + '"' +
                '}';

            var result = $.ajax({
                async: false,
                url: url,
                type: "POST",
                dataType: "json",
                data: data,

                success: function(resultat, statut, erreur) {
                    console.log("RESULTAT : \n" + JSON.stringify(resultat) + "\n\nSTATUT : " + statut + "\n\nERREUR : " + JSON.stringify(erreur));
                },

                error: function(resultat, statut, erreur) {
                    console.log("RESULTAT : \n" + JSON.stringify(resultat) + "\n\nSTATUT : " + statut + "\n\nERREUR : " + JSON.stringify(erreur));
                }

            });

            if (result.status == 404) {
                msg = "Impossible d'atteindre l'URL demandée.";
            } else if (result.status == 0) {
                msg = "Erreur : syntaxe de l'URL erronée";
            } else {
                msg = JSON.stringify(result.responseText);
                msg = msg.replace("\"", "").replace("\"", "");
            }

            $("#result").text(msg);

            if (result.status == 200) {
                localStorage.setItem('login', login);
                localStorage.setItem('backend', backend);
                localStorage.setItem('connected', true);
                document.location.href = "index.html";
            }

        });
    </script>

</body>

</html>